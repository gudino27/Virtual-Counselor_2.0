{
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c6899606-1bbe-47a7-b0ed-cd086fee6c54",
              "name": "terms",
              "value": "={{ $json.terms }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -48,
        176
      ],
      "id": "f7acda53-6604-44e2-9aeb-117f7c15729b",
      "name": "Extract Term Fields"
    },
    {
      "parameters": {
        "fieldToSplitOut": "terms",
        "include": "allOtherFields",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -192,
        176
      ],
      "id": "80f5b577-8082-4936-96c7-e0aa2f069cf9",
      "name": "Split Term Data"
    },
    {
      "parameters": {
        "amount": 0.25
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2144,
        192
      ],
      "id": "822d2b92-a7c0-41ef-a638-9d312cf054d1",
      "name": "Wait Between Batches",
      "webhookId": "74dd2b7d-b531-4816-a06e-eea5b96f28fb"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3008/webhook/courses",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "f164fdb7-fc2d-4af0-ae93-41a1d35510b9",
      "name": "Save to Database",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1984,
        192
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": []
        },
        "includeOtherFields": true,
        "include": "except",
        "excludeFields": "footnotes,crossConjointList",
        "options": {}
      },
      "id": "8366f7ea-f7f9-428d-8901-2e513a2d2995",
      "name": "Clean Section Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1664,
        192
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Flatten sectionInfo to root level and prepare for database\nconst item = $input.item.json;\n// Check if sectionInfo exists\nif (!item.sectionInfo) {\n  console.log('âš ï¸ No sectionInfo found for:', item.campus, item.term, item.year, item.prefix);\n  return { json: {} };\n}\n\nconst info = item.sectionInfo;\n\n// Convert term number to term name\nconst termNum = parseInt(info.term);\nlet termName = info.term;\nif (termNum === 1) {\n  termName = \"Spring\";\n} else if (termNum === 2) {\n  termName = \"Summer\";\n} else if (termNum === 3) {\n  termName = \"Fall\";\n}\n\n// Map API fields to SQLite database fields\nconst max = info.enrollmentLimit || 0;\nconst current = info.enrollment || 0;\nconst seatsAvail = Math.max(0, max - current);\n\n// Calculate status and waitlist\nlet status = \"\";\nlet waitlistCount = 0;\nlet waitlistCapacity = 0;\nlet waitlistAvailable = 0;\n\nif (max > current) {\n  status = \"open\";\n} else if (max === current) {\n  status = \"full\";\n} else if (max < current) {\n  const capacity = current - max;\n  status = \"waitlisted\";\n  waitlistCount = capacity;\n  waitlistCapacity = capacity;\n  waitlistAvailable = 0;\n}\n\n// Build complete course data object with ALL fields from API\nconst courseData = {\n  // Basic course info\n  campus: info.campus,\n  term: termName,\n  year: info.year,\n  prefix: info.prefix,\n  subject: info.subject,\n  courseNumber: info.courseNumber,\n  sectionNumber: info.sectionNumber,\n  isLab: info.isLab || false,\n  title: info.title,\n  sectionTitle: info.sectionTitle,\n  credits: info.credits,\n  instructor: info.instructor,\n  sln: info.sln,\n\n  // Course details\n  courseDescription: info.courseDescription,\n  coursePrerequisite: info.coursePrerequisite,\n  sectionComment: info.sectionComment,\n  sectionUrl: info.sectionUrl,\n  dayTime: info.dayTime,\n  location: info.location,\n  site: info.site,\n  startDate: info.startDate,\n  endDate: info.endDate,\n\n  // Enrollment data\n  seatsAvailable: seatsAvail,\n  maxEnrollment: max,\n  currentEnrollment: current,\n  waitlistAvailable: waitlistAvailable,\n  waitlistCapacity: waitlistCapacity,\n  waitlistCount: waitlistCount,\n  status: status,\n\n  // Important dates\n  dateLastAuditToCredit: info.dateLastAuditToCredit,\n  dateLastCreditToAudit: info.dateLastCreditToAudit,\n  dateLastFinalGradeSubmit: info.dateLastFinalGradeSubmit,\n  dateLastInstruction: info.dateLastInstruction,\n  dateLastLtrGradeToPf: info.dateLastLtrGradeToPf,\n  dateLastPftoLtrGrade: info.dateLastPftoLtrGrade,\n  dateLastRegWithoutFee: info.dateLastRegWithoutFee,\n  dateLastStdAdd: info.dateLastStdAdd,\n  dateLastStdDrop: info.dateLastStdDrop,\n  dateLastWdrwl: info.dateLastWdrwl,\n  dateRegBegin: info.dateRegBegin,\n  dateRegEnd: info.dateRegEnd,\n\n  // Course attributes\n  slnrestrict: info.slnrestrict,\n  ger: info.ger,\n  diversity: info.diversity,\n  writing: info.writing,\n  courseFee: info.courseFee,\n  isMultipleFees: info.isMultipleFees,\n  titleAllowed: info.titleAllowed,\n  showInstructors: info.showInstructors,\n  ucore: info.ucore,\n  coop: info.coop,\n  schedulePrint: info.schedulePrint,\n  instructionMode: info.instructionMode,\n  session: info.session,\n  consent: info.consent,\n  minUnits: info.minUnits,\n  maxUnits: info.maxUnits,\n  gradCaps: info.gradCaps,\n  footnotes: info.footnotes,\n\n  // Complex data (arrays)\n  instructors: info.instructors || [],\n  meetings: info.meetings || [],\n\n  // Metadata\n  scrapedAt: new Date().toISOString()\n};\n\nreturn { json: courseData };\n"
      },
      "id": "08194138-72b3-412e-ba71-6a86839473ce",
      "name": "Format for Database",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1824,
        192
      ]
    },
    {
      "parameters": {
        "url": "=https://schedules.wsu.edu/api/Data/GetSectionInfo/{{ $json.campus }}/{{ $json.term }}/{{ $json.year }}/{{ $json.prefix }}/{{ $json.courseNumber }}/{{ $json.sectionNumber }}/{{ $json.isLab }}/true",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          },
          "timeout": 30000
        }
      },
      "id": "55e75ec7-2add-4cd7-8004-d8add1506a8c",
      "name": "Get Section Details",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1520,
        192
      ],
      "retryOnFail": true,
      "maxTries": 5
    },
    {
      "parameters": {
        "batchSize": 500,
        "options": {}
      },
      "id": "3154de16-031a-4cd2-80f4-3a1db617a5d4",
      "name": "Batch Sections (500)",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1360,
        176
      ]
    },
    {
      "parameters": {
        "fieldToSplitOut": "sections",
        "options": {}
      },
      "id": "0b5fcdb6-9def-4821-9d1b-4177af704311",
      "name": "Split Sections into Items",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        1184,
        176
      ]
    },
    {
      "parameters": {
        "url": "=https://schedules.wsu.edu/api/Data/GetSectionListDTO/{{ $json.campus }}/{{ $json.term }}/{{ $json.year }}/{{ $json.prefix }}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          },
          "timeout": 30000
        }
      },
      "id": "b0de5d10-409f-4cd7-a076-d213e07bb2d7",
      "name": "Get Course Sections",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1008,
        176
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bd509112-3a03-4ae5-b9d5-62205831fed4",
              "name": "prefix",
              "value": "={{ $json.prefix }}",
              "type": "string"
            },
            {
              "id": "a2e97aa4-41e5-4dbf-bd23-f757602b0e1f",
              "name": "subject",
              "value": "={{ $json.subject }}",
              "type": "string"
            },
            {
              "id": "19f7c1e8-4807-499f-918e-5d4163591652",
              "name": "title",
              "value": "={{ $json.title }}",
              "type": "string"
            },
            {
              "id": "bea8034c-92d1-417a-9f7c-dd9901037f57",
              "name": "campus",
              "value": "={{ $('Filter Active Semesters').item.json.terms.campus }}",
              "type": "string"
            },
            {
              "id": "1410ac24-553c-4fb0-b2c8-b24d163494ee",
              "name": "term",
              "value": "={{ $('Filter Active Semesters').item.json.terms.term }}",
              "type": "string"
            },
            {
              "id": "65632d2e-2ca6-4e59-befd-fc9c81925b29",
              "name": "year",
              "value": "={{ $('Filter Active Semesters').item.json.terms.year }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "include": "selected",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        848,
        176
      ],
      "id": "f54d912e-d373-426b-b851-ec91f704aea8",
      "name": "Prepare Prefix Data"
    },
    {
      "parameters": {
        "fieldToSplitOut": "prefix,subject,title",
        "options": {}
      },
      "id": "879d7b45-6b54-4353-83e6-81ecf5317dd5",
      "name": "Split Prefixes into Items",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        672,
        176
      ]
    },
    {
      "parameters": {
        "url": "=https://schedules.wsu.edu/api/Data/GetPrefixList/{{$json.terms.campus }}/{{ $json.terms.term }}/{{$json.terms.year  }}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          },
          "timeout": 30000
        }
      },
      "id": "ce5fdc76-0212-4137-a994-f98a5da64362",
      "name": "Get Course Prefixes",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        496,
        176
      ]
    },
    {
      "parameters": {
        "fieldToSplitOut": "terms",
        "options": {}
      },
      "id": "7be41513-9fac-4b1f-88b7-03d0519c0283",
      "name": "Split Terms into Items",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -336,
        176
      ]
    },
    {
      "parameters": {
        "url": "https://schedules.wsu.edu/api/Data/GetHomePageDTO",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7"
            },
            {
              "name": "accept-language",
              "value": "en-US,en;q=0.9,es;q=0.8"
            },
            {
              "name": "cache-control",
              "value": "max-age=0"
            },
            {
              "name": "priority",
              "value": "u=0, i"
            },
            {
              "name": "sec-ch-ua",
              "value": "\"Chromium\";v=\"142\", \"Google Chrome\";v=\"142\", \"Not_A Brand\";v=\"99\""
            },
            {
              "name": "sec-ch-ua-mobile",
              "value": "?0"
            },
            {
              "name": "sec-ch-ua-platform",
              "value": "\"Windows\""
            },
            {
              "name": "sec-fetch-dest",
              "value": "document"
            },
            {
              "name": "sec-fetch-mode",
              "value": "navigate"
            },
            {
              "name": "sec-fetch-site",
              "value": "none"
            },
            {
              "name": "sec-fetch-user",
              "value": "?1"
            },
            {
              "name": "upgrade-insecure-requests",
              "value": "1"
            },
            {
              "name": "user-agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
            },
            {
              "name": "cookie",
              "value": "PS_TokenSite=https://my.wsu.edu/psc/wsucsprd/?csprd-web-8080-PORTAL-PSJSESSIONID;_fbp=fb.1.1741473728849.62726893104847452;_tt_enable_cookie=1;_ttp=01JNVYRJF3BF9AVQJERKS9SSY7_.tt.1;_scid=vdT-xlMb5jgtJ-CqfcFOFaTpukPXNXSZ;_ga_YEKG02558S=GS1.1.1741487647.3.1.1741488081.0.0.0;_ga_VDDN5X00T3=GS1.1.1743203766.5.0.1743203766.0.0.0;_ga_5KYYGMBFYL=GS1.1.1744340201.4.1.1744340215.0.0.0;_ga_NMJ515QV7F=GS1.2.1744707053.4.1.1744707058.0.0.0;_ga_MM5HVW1DTR=GS1.1.1744707052.4.1.1744707076.0.0.0;_ga_DZGEFB395J=GS1.1.1745307554.1.0.1745307559.0.0.0;_ga_LRP01RTGGF=GS1.1.1745373045.3.0.1745373045.0.0.0;_ga_N3K3DFP4YX=GS1.2.1745875173.1.0.1745875173.0.0.0;_ga_TJ7SZWFH9C=GS1.1.1745875173.1.1.1745875184.0.0.0;_ga_VT09SY4LS0=GS1.1.1746118749.1.0.1746118753.0.0.0;_ga_YZ7JSTC229=GS2.2.s1746689207$o1$g0$t1746689207$j0$l0$h0;_ga_M5P1HD5VVD=GS2.1.s1746689206$o1$g0$t1746689211$j0$l0$h0;_ga_PBT4EE8N4Y=GS2.1.s1747268901$o1$g1$t1747268966$j0$l0$h0;_ga_4LDZ1Z8TPG=GS2.1.s1747365873$o2$g1$t1747365899$j34$l0$h0;_ga_9GNR8081WJ=GS2.2.s1747365873$o2$g1$t1747365899$j0$l0$h0;_ga_QY8TGC3PVS=GS2.2.s1747949273$o2$g0$t1747949273$j0$l0$h0;_ga_7ELQQS5Q5Z=GS2.1.s1747949273$o3$g1$t1747949783$j60$l0$h0$d7_zpq2IJPT90bkeoMy1UBJH4VpAie0pwXg;_ga_7DMM37HW78=GS2.1.s1749454734$o1$g1$t1749454738$j56$l0$h0;ttcsid=1749454734947::VKEBLzTgVth8EZa0ysxB.12.1749454759428;_ga_VPX04D41M2=GS2.2.s1749454759$o1$g0$t1749454759$j60$l0$h0;ttcsid_C571MA4K7EFNSJPVTQ9G=1749454734947::Sl2gCFSI0TNgWEAg4HdW.12.1749454759729;_ga_QWYZ0RPY9N=GS2.1.s1749454759$o1$g1$t1749454775$j44$l0$h0;_ga_R1VW9HHKLV=GS2.1.s1749454734$o18$g1$t1749454775$j19$l0$h0;_ga_NKLQ3WM1L0=GS2.1.s1749454734$o18$g1$t1749454775$j19$l0$h0;_ga_X27EYKSLHZ=GS2.1.s1749454734$o18$g1$t1749454775$j19$l0$h0;_ga_MKG6FD1HWL=GS2.1.s1749454734$o18$g1$t1749454775$j19$l0$h0;_ga_B8RSX4BEQ9=GS2.1.s1749454734$o18$g1$t1749454775$j19$l0$h0;_ga_DFL6NBBRQG=GS2.1.s1749454734$o18$g1$t1749454775$j19$l0$h0;_ga_BYWR100R39=GS2.1.s1749454734$o18$g1$t1749454775$j19$l0$h0;_ga_D6J2RR3GK1=GS2.1.s1749454734$o13$g1$t1749454775$j19$l0$h0;_ga_RDBMYMNW2Q=GS2.1.s1753583646$o1$g0$t1753583654$j52$l0$h0;_ga_QWEDLBFRV0=GS2.1.s1753583646$o1$g0$t1753583654$j52$l0$h0;_ga_G2WHLF4XFL=GS2.2.s1753583913$o1$g0$t1753583913$j60$l0$h0;_ga_N8BYKL3SXL=GS2.1.s1753583913$o1$g0$t1753583919$j54$l0$h0;_ga_DR38EX6NLC=GS2.2.s1753584442$o1$g0$t1753584442$j60$l0$h0;_ga_844N90NQ1Z=GS2.1.s1753584442$o1$g1$t1753585183$j60$l0$h0;_ga_2SK9Y0XXMP=GS2.1.s1754170424$o10$g0$t1754170556$j60$l0$h0;lcsrftoken=NDjD4SxKMTjbde7kemVkviv7aDNR4MsrzuOoDFipR/k=;_ga_VSS5MBFKDQ=GS2.1.s1755885556$o3$g0$t1755885556$j60$l0$h0;_gcl_au=1.1.246485408.1758161192;_ga_GXCYFV40PT=GS2.2.s1758161192$o1$g0$t1758161203$j49$l0$h0;_ga_3SHN0QEJCJ=GS2.1.s1758161192$o1$g1$t1758161215$j37$l0$h0;_ga_SPNBC1MCJ3=GS2.2.s1758161221$o1$g0$t1758161224$j57$l0$h0;_ga_PLREEGL188=GS2.1.s1758161221$o1$g1$t1758161229$j52$l0$h0;_ga_X4CJTFTR78=GS2.2.s1760740155$o17$g1$t1760740487$j35$l0$h0;_ga_20TYKEKNGK=GS2.2.s1760740155$o1$g1$t1760740487$j35$l0$h0;_ga_Y1JP6CM6M6=GS2.2.s1760740155$o1$g1$t1760740493$j60$l0$h0;_ga_V2X61DH1KV=GS2.2.s1761642094$o1$g0$t1761642094$j60$l0$h0;_ga_N0SXPDCSDZ=GS2.1.s1761642094$o1$g0$t1761642099$j55$l0$h0;_ga_C2TCHJ8XTF=GS2.2.s1761642094$o4$g0$t1761642100$j54$l0$h0;_ga_XYP579T6XH=GS2.2.s1761642100$o1$g0$t1761642100$j60$l0$h0;_ga_L0RDL5J4SZ=GS2.1.s1761642100$o1$g0$t1761642103$j57$l0$h0;_ga_SHBCY4SXQZ=GS2.2.s1762214950$o3$g0$t1762214950$j60$l0$h0;_ga_51RTRL4VKT=GS2.1.s1762214950$o3$g0$t1762214959$j51$l0$h0;_ga_BHWN9K53F7=GS2.2.s1762214960$o3$g0$t1762214960$j60$l0$h0;_ga_XXBFVCWQ4Z=GS2.1.s1762217901$o5$g0$t1762217901$j60$l0$h0;_ga_VYYR8Z61RT=GS2.2.s1762236510$o1$g0$t1762236510$j60$l0$h0;_ga_HVV930WCF8=GS2.1.s1762244002$o2$g0$t1762244002$j60$l0$h0;_ga_8VMBK90ESJ=GS2.2.s1762251064$o2$g1$t1762251115$j9$l0$h0;_ga_SSSFXPYC9N=GS2.1.s1762251064$o2$g1$t1762251117$j7$l0$h0;_ga_BKX339Y46J=GS2.1.s1762285510$o1$g1$t1762285533$j37$l0$h0;_ga_MTCBDJYSKC=GS2.2.s1762285542$o1$g0$t1762285542$j60$l0$h0;_ga_QMJZMBZH9X=GS2.1.s1762285542$o1$g0$t1762285548$j54$l0$h0;_ga_MWX65V4J8J=GS2.1.s1762285370$o1$g1$t1762287231$j60$l0$h0;_ga_RZWWF2YTDK=GS2.2.s1762299182$o1$g0$t1762299182$j60$l0$h0;_ga_P56L4FQE67=GS2.1.s1762299182$o1$g1$t1762299392$j60$l0$h0;_ga_F24CW0XKVB=GS2.1.s1762412606$o2$g0$t1762412606$j60$l0$h0;_ga_2TF00PMKQL=GS2.2.s1762417750$o1$g0$t1762417750$j60$l0$h0;_ga_9H7N85HWKH=GS2.1.s1762417750$o1$g1$t1762417794$j16$l0$h0;_ga_2LEH1404ZG=GS2.1.s1762423007$o2$g0$t1762423007$j60$l0$h0;csprd-web-8080-PORTAL-PSJSESSIONID=rCl_UpV1rBCSwSrIyQlcPLXh1YPNV5Gl!-1232727803;_ga_26ETDYW1NE=GS2.1.s1763075845$o57$g0$t1763075845$j60$l0$h0;ApplicationGatewayAffinityCORS=89f98b81a3091255dcaf39d748f9b8b4;ApplicationGatewayAffinity=89f98b81a3091255dcaf39d748f9b8b4;_ga_QWHD7R3CNJ=GS2.1.s1763260661$o39$g0$t1763260661$j60$l0$h0;_ScCbts=%5B%22229%3Bchrome.2%3A2%3A5%22%5D;_sctr=1%7C1763193600000;_ga_XMM38JS40Y=GS2.2.s1763432945$o25$g0$t1763432945$j60$l0$h0;_gid=GA1.2.63874780.1763705597;_ga=GA1.1.698744992.1741473441;_ga_PQ2KLVLSG3=GS2.1.s1763705597$o19$g1$t1763705605$j52$l0$h0;_ga_CFV4Y78L3N=GS2.1.s1763705596$o87$g1$t1763705605$j51$l0$h0;_ga_45KYZDYHXM=GS2.1.s1763705596$o87$g1$t1763705605$j51$l0$h0;_ga_CRRLFVKBEZ=GS2.1.s1763705596$o14$g1$t1763705605$j51$l0$h0;_ga_21J2T8F97G=GS2.2.s1763705597$o11$g0$t1763705605$j52$l0$h0;_scid_r=y1T-xlMb5jgtJ-CqfcFOFaTpukPXNXSZOLlbpA;"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -496,
        176
      ],
      "id": "c18ceec6-7618-4ece-9704-6e2dbc36bbdd",
      "name": "Get Available Terms"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours"
            }
          ]
        }
      },
      "id": "9ab531f2-9c45-4938-8eac-a96fe81ce074",
      "name": "Hourly Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -816,
        176
      ]
    },
    {
      "parameters": {
        "jsCode": "// Smart Semester Detection for WSU Course Scraper\n// Determines which terms to scrape based on mode (initial vs hourly) and current month\n\nconst items = $input.all();\n\n// Get database check result from HTTP Request1 node\nconst dbCheck = $('Check Database Status').item.json;\nconst hasCoursesInDb = dbCheck?.courses && dbCheck.courses.length > 0;\n\n// Get current date/time\nconst now = new Date();\nconst currentMonth = now.getMonth() + 1; // 1-12\nconst currentYear = now.getFullYear();\n\n// Determine which semesters to scrape based on current month\nlet targetSemesters = [];\n\nif (currentMonth >= 10 || currentMonth === 1) {\n  // October - January: Spring only (next year if Oct-Dec)\n  const springYear = currentMonth >= 10 ? currentYear + 1 : currentYear;\n  targetSemesters.push({ term: 'Spring', year: springYear });\n} else if (currentMonth >= 2 && currentMonth <= 7) {\n  // February - July: Summer (always)\n  targetSemesters.push({ term: 'Summer', year: currentYear });\n\n  if (currentMonth >= 3) {\n    // March - July: Also Fall (overlap period)\n    targetSemesters.push({ term: 'Fall', year: currentYear });\n  }\n} else {\n  // August - September: Fall only\n  targetSemesters.push({ term: 'Fall', year: currentYear });\n}\n\n// Process each item and add shouldScrapeThisSemester flag\nconst processedItems = items.map(item => {\n  const termData = item.json.terms;\n  let shouldScrape = false;\n\n  if (!hasCoursesInDb) {\n    // INITIAL MODE: Scrape all terms with show:true (no filtering)\n    shouldScrape = true;\n  } else {\n    // HOURLY MODE: Only scrape if this term matches current active semester(s)\n    shouldScrape = targetSemesters.some(t =>\n      t.term === termData.term && t.year === termData.year\n    );\n  }\n\n  return {\n    json: {\n      ...item.json,\n      shouldScrapeThisSemester: shouldScrape\n    }\n  };\n});\n\n// Logging for debugging\nconst mode = hasCoursesInDb ? 'HOURLY UPDATE' : 'INITIAL SCRAPE';\nconst semesterNames = targetSemesters.map(s => `${s.term} ${s.year}`).join(' + ');\nconst itemsToScrape = processedItems.filter(i => i.json.shouldScrapeThisSemester).length;\n\nconsole.log(`ðŸ“… Current date: ${now.toISOString()}`);\nconsole.log(`ðŸ” Database check: ${hasCoursesInDb ? 'Courses found' : 'No courses found'}`);\nconsole.log(`âš™ï¸  Mode: ${mode}`);\nconsole.log(`ðŸ“š Target semester(s): ${semesterNames}`);\nconsole.log(`ðŸ“Š Filtering ${items.length} terms â†’ ${itemsToScrape} will be scraped`);\n\nreturn processedItems;"
      },
      "id": "582deb44-9f0f-4bf2-8003-33802fd14d83",
      "name": "Calculate Semester Filter",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        128,
        176
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "2b8e5c7b-d170-4c0e-b3e3-4ce0cc316c80",
              "leftValue": "={{ $('Check Database Status').item.json.courses }}",
              "rightValue": "true",
              "operator": {
                "type": "array",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "d8d3a34d-a0c6-4436-845d-9dc9a36fc5ab",
              "leftValue": "={{ $json.terms.show }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "9ec640e9-f190-42af-b79d-71e236182091",
              "leftValue": "={{ $json.shouldScrapeThisSemester }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        320,
        176
      ],
      "id": "a1989657-7839-41b1-8b81-48a2fe0c2e39",
      "name": "Filter Active Semesters"
    },
    {
      "parameters": {
        "url": "http://localhost:3008/api/courses",
        "options": {
          "allowUnauthorizedCerts": true,
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 5000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -672,
        176
      ],
      "id": "3f2b762a-f5fa-4b01-b547-31cdfac771eb",
      "name": "Check Database Status",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 0 10 3 *"
            }
          ]
        }
      },
      "id": "4102fca7-e328-4090-8d51-a4bf5808ed69",
      "name": "Yearly Schedule",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -832,
        336
      ],
      "notes": "Run every March 10th to update catalog"
    },
    {
      "parameters": {},
      "id": "808b9ad2-618a-48a7-b29d-fd872ad9b599",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -832,
        544
      ]
    },
    {
      "parameters": {
        "url": "http://localhost:3008/api/catalog/years",
        "options": {}
      },
      "id": "af9e4151-9fc7-462c-8bab-c583c4946ec5",
      "name": "Check Loaded Years",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -624,
        448
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const loadedYears = $input.item.json.years || [];\nconst currentYear = new Date().getFullYear();\nconst historicalYears = ['2020', '2021', '2022', '2023', '2024'];\nconst missingHistorical = historicalYears.filter(y => !loadedYears.includes(y));\nconst needsCurrentYear = !loadedYears.includes(String(currentYear)) || currentYear > 2024;\n\nreturn {\n  json: {\n    loadedYears,\n    currentYear,\n    missingHistorical,\n    needsCurrentYear,\n    needsHistoricalLoad: missingHistorical.length > 0\n  }\n};"
      },
      "id": "0402ecd7-272b-49e6-b2ad-ffb4e06efc2f",
      "name": "Determine Actions",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -448,
        448
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "c1",
              "leftValue": "={{ $json.needsHistoricalLoad }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ac1120b8-66f5-4f3a-9905-272fbeb0e7c6",
      "name": "Needs Historical?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -272,
        448
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3008/api/catalog/init",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={ \"years\": {{ JSON.stringify($json.missingHistorical) }} }",
        "options": {}
      },
      "id": "8d89867d-146f-4be5-b093-3632d0ba3ae6",
      "name": "Load Historical Data",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -48,
        352
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "c2",
              "leftValue": "={{ $('Determine Actions').item.json.needsCurrentYear }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "8f5306b9-b532-42cf-9ee7-57bab5514ea0",
      "name": "Needs Current Year?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        160,
        464
      ]
    },
    {
      "parameters": {
        "url": "https://catalog.wsu.edu/api/Data/GetDegreesDropdown/General",
        "options": {
          "timeout": 30000
        }
      },
      "id": "a438378e-3bd9-4c16-beee-eeb672118dbe",
      "name": "Fetch Degrees List",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        336,
        448
      ],
      "notes": "Get all degrees to extract unique acadUnitIds"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Extract unique acadUnitIds from the degrees list\nlet items = $input.item.json;\nif (!Array.isArray(items)) {\n  items = [items];\n}\n\n// Get unique acadUnitIds\nconst uniqueUnits = new Map();\nfor (const item of items) {\n  if (item.acadUnitId && !uniqueUnits.has(item.acadUnitId)) {\n    uniqueUnits.set(item.acadUnitId, {\n      acadUnitId: item.acadUnitId,\n      acadUnit: item.acadUnit || item.title\n    });\n  }\n}\n\nconst unitList = Array.from(uniqueUnits.values());\nconsole.log(`Found ${unitList.length} unique academic units`);\n\nreturn {\n  json: {\n    units: unitList,\n    count: unitList.length,\n    currentYear: new Date().getFullYear()\n  }\n};"
      },
      "id": "649431f5-1880-4ed7-ac18-75b392837614",
      "name": "Extract Unique Units",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        512,
        448
      ]
    },
    {
      "parameters": {
        "fieldToSplitOut": "units",
        "options": {}
      },
      "id": "ec744c37-5b11-4ba1-ab58-f522a4253f80",
      "name": "Split Units",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        736,
        448
      ]
    },
    {
      "parameters": {
        "url": "=https://catalog.wsu.edu/api/Data/GetAcademicUnit/{{ $json.acadUnitId }}/General",
        "options": {
          "timeout": 30000
        }
      },
      "id": "3c24557c-1626-4712-9dc6-875cf5c4d25d",
      "name": "Fetch Unit Details",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        928,
        448
      ],
      "notes": "Get degrees, minors, certificates for each unit"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Extract degrees, minors, certificates from API response\n// API returns: degreePrograms, minors, certificates at root level\nconst data = $input.item.json;\nconst currentYear = new Date().getFullYear();\n\nconst unitName = data.unit?.name || data.title || 'Unknown';\n\n// Extract degree programs (API uses 'degreePrograms' not 'degrees')\nconst degrees = (data.degreePrograms || []).map(d => ({\n  externalId: d.id,\n  name: d.title || d.text,\n  hours: d.hours,\n  type: 'Degree',\n  department: unitName,\n  url: `https://catalog.wsu.edu/General/Academics/DegreeProgram/${d.id}`,\n  catalogYear: String(currentYear),\n  sourceType: 'api'\n}));\n\n// Extract minors\nconst minors = (data.minors || []).map(m => ({\n  externalId: m.id,\n  name: m.title || m.text,\n  type: 'Minor',\n  department: unitName,\n  url: `https://catalog.wsu.edu/General/Academics/Minor/${m.id}`,\n  catalogYear: String(currentYear),\n  sourceType: 'api'\n}));\n\n// Extract certificates\nconst certificates = (data.certificates || []).map(c => ({\n  externalId: c.id,\n  name: c.title || c.text,\n  type: 'Certificate',\n  department: unitName,\n  url: `https://catalog.wsu.edu/General/Academics/Certificate/${c.id}`,\n  catalogYear: String(currentYear),\n  sourceType: 'api'\n}));\n\nreturn {\n  json: {\n    unitName,\n    degrees,\n    minors,\n    certificates,\n    counts: {\n      degrees: degrees.length,\n      minors: minors.length,\n      certificates: certificates.length\n    }\n  }\n};"
      },
      "id": "0b2ff90a-c1e2-4c68-bb10-d10ea633ba11",
      "name": "Parse Unit Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1296,
        448
      ]
    },
    {
      "parameters": {
        "jsCode": "// Aggregate all results from all units\nconst allDegrees = [];\nconst allMinors = [];\nconst allCertificates = [];\nconst currentYear = new Date().getFullYear();\n\n// Collect from all items\nfor (const item of $input.all()) {\n  const data = item.json;\n  if (data.degrees) allDegrees.push(...data.degrees);\n  if (data.minors) allMinors.push(...data.minors);\n  if (data.certificates) allCertificates.push(...data.certificates);\n}\n\n// Deduplicate by externalId\nconst uniqueDegrees = [...new Map(allDegrees.map(d => [d.externalId, d])).values()];\nconst uniqueMinors = [...new Map(allMinors.map(m => [m.externalId, m])).values()];\nconst uniqueCertificates = [...new Map(allCertificates.map(c => [c.externalId, c])).values()];\n\nconsole.log(`Aggregated: ${uniqueDegrees.length} degrees, ${uniqueMinors.length} minors, ${uniqueCertificates.length} certificates`);\n\nreturn {\n  json: {\n    catalogYear: String(currentYear),\n    degrees: uniqueDegrees,\n    minors: uniqueMinors,\n    certificates: uniqueCertificates,\n    counts: {\n      degrees: uniqueDegrees.length,\n      minors: uniqueMinors.length,\n      certificates: uniqueCertificates.length,\n      total: uniqueDegrees.length + uniqueMinors.length + uniqueCertificates.length\n    }\n  }\n};"
      },
      "id": "24432418-55a2-4d5f-9013-2d2eece58844",
      "name": "Aggregate Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1472,
        448
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3008/webhook/catalog-programs",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"catalogYear\": \"{{ $json.catalogYear }}\",\n  \"degrees\": {{ JSON.stringify($json.degrees) }},\n  \"minors\": {{ JSON.stringify($json.minors) }},\n  \"certificates\": {{ JSON.stringify($json.certificates) }},\n  \"sourceType\": \"api\"\n}",
        "options": {}
      },
      "id": "b07099db-1c1f-470a-bb78-ade37f64f748",
      "name": "Save to Database1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1648,
        448
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bb606513-2397-4f9d-85c1-ff5ab7dc3259",
              "name": "certificates",
              "value": "={{ $json.certificates }}",
              "type": "array"
            },
            {
              "id": "8159e1bd-e37b-4bc0-96e4-b19722bd434e",
              "name": "minors",
              "value": "={{ $json.minors }}",
              "type": "array"
            },
            {
              "id": "2f25008d-2ac4-41cf-9392-92bc880a77e4",
              "name": "degreePrograms",
              "value": "={{ $json.degreePrograms }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1120,
        448
      ],
      "id": "4176ba2f-dbd0-4e75-a693-08f4ab35c2e1",
      "name": "Edit Fields"
    }
  ],
  "connections": {
    "Extract Term Fields": {
      "main": [
        [
          {
            "node": "Calculate Semester Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Term Data": {
      "main": [
        [
          {
            "node": "Extract Term Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait Between Batches": {
      "main": [
        [
          {
            "node": "Batch Sections (500)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Database": {
      "main": [
        [
          {
            "node": "Wait Between Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clean Section Data": {
      "main": [
        [
          {
            "node": "Format for Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for Database": {
      "main": [
        [
          {
            "node": "Save to Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Section Details": {
      "main": [
        [
          {
            "node": "Clean Section Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Batch Sections (500)": {
      "main": [
        [],
        [
          {
            "node": "Get Section Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Sections into Items": {
      "main": [
        [
          {
            "node": "Batch Sections (500)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Course Sections": {
      "main": [
        [
          {
            "node": "Split Sections into Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Prefix Data": {
      "main": [
        [
          {
            "node": "Get Course Sections",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Prefixes into Items": {
      "main": [
        [
          {
            "node": "Prepare Prefix Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Course Prefixes": {
      "main": [
        [
          {
            "node": "Split Prefixes into Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Terms into Items": {
      "main": [
        [
          {
            "node": "Split Term Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Available Terms": {
      "main": [
        [
          {
            "node": "Split Terms into Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Hourly Trigger": {
      "main": [
        [
          {
            "node": "Check Database Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Semester Filter": {
      "main": [
        [
          {
            "node": "Filter Active Semesters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Active Semesters": {
      "main": [
        [
          {
            "node": "Get Course Prefixes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Database Status": {
      "main": [
        [
          {
            "node": "Get Available Terms",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Yearly Schedule": {
      "main": [
        [
          {
            "node": "Check Loaded Years",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Check Loaded Years",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Loaded Years": {
      "main": [
        [
          {
            "node": "Determine Actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Determine Actions": {
      "main": [
        [
          {
            "node": "Needs Historical?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Historical?": {
      "main": [
        [
          {
            "node": "Load Historical Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Needs Current Year?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Historical Data": {
      "main": [
        [
          {
            "node": "Needs Current Year?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Current Year?": {
      "main": [
        [
          {
            "node": "Fetch Degrees List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Degrees List": {
      "main": [
        [
          {
            "node": "Extract Unique Units",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Unique Units": {
      "main": [
        [
          {
            "node": "Split Units",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Units": {
      "main": [
        [
          {
            "node": "Fetch Unit Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Unit Details": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Unit Data": {
      "main": [
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Results": {
      "main": [
        [
          {
            "node": "Save to Database1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Parse Unit Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "0b1e52c34222f35edf776466cf514c230937e64c33c6cedaf4a6b422983821c1"
  }
}